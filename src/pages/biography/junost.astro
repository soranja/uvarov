---
// COMPONENTS
import BioWrapper from "../../components/biography/BioWrapper.astro";
import HeaderWrapper from "../../components/global/header/HeaderWrapper.astro";
import ScrollArrow from "../../components/global/ScrollArrow.astro";
import Section from "../../components/global/Section.astro";
import InfoOverlay from "../../components/global/InfoOverlay.astro";
import Chapter from "../../components/biography/Chapter.astro";

import { common, junostAssets } from "../../data/data";

const uvarovYoung1 = [junostAssets.uvarovYoung1, junostAssets.handwrite1Full];
const uvarovYoung2 = [junostAssets.uvarovYoung2Full, junostAssets.handwrite2Full];
const graf = [junostAssets.graf];
const diploma = [junostAssets.diploma];
---

<style>
    .splide__arrow {
        background: transparent;
        width: auto;
    }

</style>

<BioWrapper>
    <!-- Chapter Intro -->
    <Chapter />

    <!-- Header -->
    <HeaderWrapper />

    <!-- Was Born -->
    <Section id="was-born" w="w-[1250px] 2xl:w-full">
        <div class="flex flex-col justify-between items-center">
            <p class="text-center max-w-6xl text-4xl 2xl:text-5xl 2xl:leading-normal pt-8">
                А. С. Уваров, родился 28 февраля
                <br>
                (11 марта) 1824 года в Петербурге.
            </p>
            <img src={junostAssets.spb.src} alt={junostAssets.spb.alt} class="relative 2xl:bottom-[-5vh]"/>
        </div>
    </Section> 

    <!-- Father / Mother -->
    <div class="relative w-full overflow-hidden" >
        <div id="room-bg" class="fixed top-0 left-0 w-full h-full bg-[url('../data/biography/_images/junost/room.png')] bg-center bg-cover z-0 transition-opacity duration-1000 opacity-0"></div>

        <!-- Father section -->
        <Section id="father"  h="h-[550px]">
            <div class="flex justify-center items-center">
                <div class="grid grid-cols-2">
                    <div class="flex items-bottom justify-bottom">
                        <img src={junostAssets.father.src} alt={junostAssets.father.alt} class="father-img max-h-[550px]">
                    </div>
            
                    <div class="flex flex-col justify-between items-end h-full py-20 text-right">
                        <p class="top-text max-w-lg self-end text-lg">
                            Семейными связями и родословной А. С. Уваров был укоренен в русской культуре и государственности, а ряд исторических событий XIX века являлись для него частью семейной хроники.
                        </p>
                        <p class="bottom-text text-2xl">
                            Отец Алексея Сергеевича, Сергей Семенович Уваров (1786–1855) – выдающийся государственный деятель, президент Петербургской Академии наук (1818–1855), министр народного просвещения (1833–1849), с именем которого связано становление в России системы общественного образования.
                        </p>
                    </div>
                </div>
            </div>
        </Section>

        <!-- Mother section -->
        <Section id="mother"  h="h-[550px]">
            <div class="flex justify-center items-center">
                <div class="grid grid-cols-2">
                    <div class="flex items-bottom justify-bottom">
                        <img src={junostAssets.mother.src} alt={junostAssets.mother.alt} class="mother-img max-h-[550px]">
                    </div>
            
                    <div class="flex flex-col justify-between items-end h-full py-20 text-right">
                        <p class="top-text max-w-lg text-lg">
                            Семейными связями и родословной А. С. Уваров был укоренен в русской культуре и государственности, а ряд исторических событий XIX века являлись для него частью семейной хроники.
                        </p>
                        <p class="bottom-text text-2xl">
                            Мать А. С. Уварова, Екатерина Алексеевна, урожденная Разумовская – 
                            <br>
                            дочь министра народного просвещения
                            <br>
                            Алексея Кирилловича и внучатая племянница 
                            <br>
                            Алексея Григорьевича Разумовских.
                        </p>
                    </div>
                </div>
            </div>
        </Section>
    </div>

    <!-- Graf -->
    <Section id="graf"  h="h-[550px]" maxH='top-[20vh] 4xl:top-[10vh]'>
        <div class="h-full w-full flex justify-center items-center">
            <div class="grid grid-cols-2 gap-x-8">

                <div id="graf-image" class="flex flex-col items-center justify-center relative">
                    <img src={junostAssets.graf.src} alt={junostAssets.graf.alt} />
                    <InfoOverlay contentType="image" images={graf} overlayId="graf" iconPosition="relative md:bottom-[6vh] 2xl:bottom-[4vh] 4xl:bottom-[2vh]"/>
                </div>

                <div class="flex flex-col justify-between items-end text-right">
                    <p class="max-w-lg text-2xl">
                        <span class="italic">
                          «За особливые заслуги и высокие достоинства»
                        </span>
                        <br>
                        <br>
                        Высочайшим указом от 1 июля 1846 года С. С. Уваров был пожалован титулом сиятельного графа с нисходящим потомством.
                    </p>
                    <p class="max-w-xl text-sm pb-[4vh]">
                        Патент императора Николая I
                        <br>
                        действительному статскому советнику
                        <br>
                        С. С. Уварову на чин тайного советника.
                    </p>
                </div>

            </div>
        </div>
    </Section>

    <!-- Library -->
    <div class="relative w-full overflow-hidden">
        <div id="library-bg" class="fixed top-0 left-0 w-full h-full bg-[url('../data/biography/_images/junost/library.png')] bg-center bg-cover bg-no-repeat z-0 transition-opacity duration-1000 opacity-0"></div>
        <Section id="library" w="w-[1360px]">
                <div class="flex flex-col justify-center items-center gap-y-[5vh]">
                    <p class="max-w-[1250px] pt-8 text-2xl leading-normal">
                        Вся атмосфера семьи Уваровых располагала к занятиям наукой и искусством. Богатейшая библиотека, коллекция живописи и антиков, собранная отцом, давала Алексею Уварову с юных лет возможность общения с ученой и творческой элитой.
                    </p>
                    <div class="w-full">
                        <div x-data="{ init() {
                                new Splide(this.$refs.splide, {
                                    perPage: 3,
                                    perMove: 1,
                                    pagination: false,
                                    breakpoints: {
                                        640: {
                                            perPage: 1,
                                        },
                                    },
                                }).mount();
                            },
                        }">
                            <section
                                class="splide"
                                aria-label="Library Slider"
                                x-ref="splide"
                                style="padding-left: 4rem; padding-right: 4rem;"
                                >
                                
                                <div class="splide__arrows">
                                    <button class="splide__arrow splide__arrow--prev">
                                        <img src={common.prevArrow.src} alt={common.prevArrow.alt}>
                                    </button>
                                    <button class="splide__arrow splide__arrow--next">
                                        <img src={common.nextArrow.src} alt={common.nextArrow.alt}>
                                    </button>
                            </div>

                                <div class="splide__track">
                                    <ul class="splide__list">
                                        {junostAssets.libraryPortraits.map((portrait) => (
                                            <li class="splide__slide flex flex-col justify-center items-center">
                                                <div class="w-[330px] h-[290px]">
                                                    <img
                                                        alt={portrait.alt}
                                                        src={portrait.src}
                                                        class="object-contain bottom-0 w-full h-full"
                                                    />
                                                </div>
                                                <div class="flex-grow text-center mt-6">
                                                    <h4 class="font-semibold text-md leading-snug">{portrait.fullName}</h4>
                                                    <p class="text-sm">{portrait.description}</p>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
        </Section>
    </div>

    <!-- Father Influence Text -->
    <Section id="father-influence" >
        <div class="flex justify-center items-center text-4xl leading-normal h-full px-[5%]">
            <p>
                Но главным в формировании личности А.С. Уварова стало влияние отца. Во многом, благодаря ему, Алексей Уваров сложился как человек европейской образованности и глубочайшей преданности России.
            </p>
        </div>
    </Section>

    <!-- Dog Animation -->
    <Section id="dog"  h="h-[600px] 2xl:h-[700px]">
        <div class="grid grid-cols-2 gap-2" >
            <div class="relative max-h-[600px] 3xl:max-h-[700px] left-[7%]">
                <video id="dog-anim" class="w-full h-full" autoplay muted>
                    <source src={junostAssets.dogAnim.src} type="video/mp4">
                </video>
                <InfoOverlay contentType="slider" images={uvarovYoung1} overlayId="dog" iconPosition="absolute bottom-6 left-1/2 transform -translate-x-1/2"/>
            </div>
            <div class="relative max-h-[600px] 3xl:max-h-[700px] right-[7%]">
                <img src={junostAssets.handwrite_1.src} alt="Почерк-1" class="relative bottom-[10%] w-full h-[700px]" />
                <p class="absolute text-sm text-right right-0 bottom-[1vh]">Алексей Сергеевич Уваров</p>
            </div>
        </div>
    </Section>

    <!-- Uni -->
    <Section id="uni"  h="h-[650px] 3xl:h-[750px]" maxH='top-[15vh] 4xl:top-[10vh]'>
        <p class="ml-[6%] text-left max-w-2xl text-xl leading-normal">
            В детстве и юности, обучаясь дома, по программе отца под его наблюдением, Уваров-младший получил основательную подготовку по истории, словесности, географии, древним и новым европейским языкам, точным и естественным наукам.
            <br>
            <br>
            Интерес к истории, древностям привел его на словесное отделение философского факультета Петербургского университета.
        </p>       
        <img src={junostAssets.spbgu.src} src={junostAssets.spbgu.alt} class="self-center object-cover absolute bottom-[-2vh]" />
    </Section> 

    <!-- Grefe -->
    <Section id="grefe" >
        <div class="flex flex-col justify-center items-start gap-y-20 text-lg md:text-2xl xl:text-3xl 3xl:text-4xl leading-normal h-full px-[1%] pb-[10%]">
            <p>
                Серьезное влияние на формирование будущего ученого оказали профессор Ф.Б. Грефе, читавший курс греческой словесности, 
                и профессор русской истории Н.Г. Устрялов.
            </p>
            <p>
                Под его влиянием Уваров выбрал тему диссертации 
                <br>
                <span class="italic">
                «Исследование, в какой степени дополняются сведения 
                о первом самозванце актами, изданными Археографической комиссией».
                </span>
            </p>
        </div>
    </Section>

     <!-- Uvarov Young -->
    <div class="relative w-full overflow-hidden">
        <div id="uvarov-bg" class="fixed top-0 left-0 w-full h-full bg-[url('../data/biography/_images/junost/uvarov_young_2.png')] bg-center bg-cover bg-no-repeat z-0 transition-opacity duration-1000 opacity-0"></div>
        <Section id="u-young"  h="h-[550px] 2xl:h-[600px] 3xl:h-[700px]" maxH='top-[15vh] 4xl:top-[10vh]'>
            <div class=" w-full h-full flex justify-center items-center">
                <div class="w-full">
                    <div class="h-[530px] w-[550px] overflow-hidden relative scrollable">
                        <div class="absolute h-[1040px] w-[550px]">
                            <img src={junostAssets.handwrite_2.src} alt="Почерк-2" class="h-[1040px] w-full object-cover object-left-top">
                        </div>
                    </div>
                </div>
            </div>
            <InfoOverlay contentType="slider" images={uvarovYoung2} isIconInverted={true} overlayId="u-young" iconPosition="absolute bottom-[1vh] left-1/2"/>
        </Section>

    </div>

    <!-- Diploma -->
    <Section id="diploma"  h="h-[600px] 2xl:h-[700px]" maxH='top-[10vh] 2xl:top-[5vh]'>
        <div class="h-full w-full flex justify-center items-center">
            <div class="grid grid-cols-3 gap-x-16">
                <div id="diploma-image" class="col-span-2 flex flex-col items-center justify-center relative max-w-[600px]">
                    <img src={junostAssets.diploma.src} alt={junostAssets.diploma.alt} class="max-h-[500px]"/>
                    <InfoOverlay contentType="image" images={diploma} overlayId="diploma" iconPosition="absolute bottom-4"/>
                </div>

                <div class="col-span-1 flex flex-col justify-between items-end text-right pb-20 pt-2 2xl:max-w-[400px] 3xl:max-w-full">
                    <p class="text-xl">
                        Окончив университет со степенью кандидата в 1845 году, поступил на службу в Министерство иностранных дел.
                    </p>
                    <p class="text-sm">
                        Диплом А.С. Уварова 
                        <br>
                        об окончании 1-го отделения 
                        <br>
                        Философского факультета разряда 
                        <br>
                        Общей словесности 
                        <br>
                        Санкт-Петербургского университета. 
                        <br>
                        14 июля 1845 г.
                    </p>
                    <p class="text-sm">
                        Подписан ректором 
                        <br>
                        Санкт-Петербургского университета
                        <br>
                        П. А. Плетнёвым</p>
                    <div class="relative">
                        <p>следующая глава</p>
                        
                        <ScrollArrow 
                            position="absolute mx-auto inset-x-0 bottom-[-10vh] 3xl:bottom-[-9vh] 4xl:bottom-[-6vh]" 
                            invert="invert" 
                            visible="opacity-100" 
                            size="w-1/3"
                            animated={false}
                            redirectUrl="/biography/expeditions"
                            />
                    </div>
                </div>
            </div>
        </div>
    </Section>

</BioWrapper>


<script>

    // SHARED BG OBSERVER
    const roomBg = document.querySelector('#room-bg') as HTMLElement;
    const libraryBg = document.querySelector('#library-bg') as HTMLElement;
    const uvarovBg = document.querySelector('#uvarov-bg') as HTMLElement;
    const targetSections = document.querySelectorAll('#mother, #father, #library, #u-young');

    let visibleSections = new Set(); // To keep track of visible sections

    const sharedBgObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                visibleSections.add(entry.target.id); // Add section ID when it enters
            } else {
                visibleSections.delete(entry.target.id); // Remove section ID when it leaves
            }

            // Handle room-bg (mother & father)
            if (visibleSections.has('mother') || visibleSections.has('father')) {
                roomBg.classList.add('opacity-100');
                roomBg.classList.remove('opacity-0');
            } else {
                roomBg.classList.remove('opacity-100');
                roomBg.classList.add('opacity-0');
            }

            // Handle library-bg (library section)
            if (visibleSections.has('library')) {
                libraryBg.classList.add('opacity-100');
                libraryBg.classList.remove('opacity-0');
            } else {
                libraryBg.classList.remove('opacity-100');
                libraryBg.classList.add('opacity-0');
            }

            // Handle uvarov-bg (portrait section)
            if (visibleSections.has('u-young')) {
                uvarovBg.classList.add('opacity-100');
                uvarovBg.classList.remove('opacity-0');
            } else {
                uvarovBg.classList.remove('opacity-100');
                uvarovBg.classList.add('opacity-0');
            }
        });
    }, { threshold: 0.5 });

    // Observe target sections
    targetSections.forEach(section => sharedBgObserver.observe(section));


    // FATHER / MOTHER SCROLL --- GSAP 
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";
    gsap.registerPlugin(ScrollTrigger);

    function animateSection(sectionId : string, imageSelector : string, bottomTextSelector : string) {
        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: `#${sectionId}`,
                start: "top center",
                end: "bottom top",
                toggleActions: "play none none reverse",
                onLeave: () => { 
                    setTimeout(() => tl.restart(false).pause(), 1000);
                },
                onLeaveBack: () => { 
                    setTimeout(() => tl.restart(false).pause(), 1000);
                },
                onEnter: () => {
                    tl.play();
                },
                onEnterBack: () => { 
                    tl.play();
                }
            }
        });

        tl.fromTo(
            imageSelector,
            { autoAlpha: 0, x: -600 },
            { autoAlpha: 1, x: 0, duration: 1.5, ease: "power2.out" },
            "+=1"
        )
        .fromTo(
            bottomTextSelector,
            { autoAlpha: 0, x: 600 },
            { autoAlpha: 1, x: 0, duration: 1.2, ease: "power2.out" },
            "+=0.3"
        );
    }

    // Father section
    animateSection("father", "#father img", "#father .bottom-text");
    // Mother section
    animateSection("mother", "#mother img", "#mother .bottom-text");


    // VIDEO PLAY ON HOVER
    const dogAnimation = document.getElementById('dog-anim') as HTMLVideoElement;
    let reverseInterval : any;

    dogAnimation.addEventListener('mouseenter', () => {
        clearInterval(reverseInterval);  // Clear reverse interval if already running
        dogAnimation.play();  // Play the video when mouse enters
    });

    dogAnimation.addEventListener('mouseleave', () => {
        dogAnimation.pause();  // Pause the video on mouse leave
        reverseVideo();  // Start reverse playback
    });

    function reverseVideo() {
        reverseInterval = setInterval(() => {
            if (dogAnimation.currentTime <= 0) {
                clearInterval(reverseInterval);  // Stop when the video reaches the start
            } else {
                dogAnimation.currentTime -= 0.05;  // Move the video time backwards
            }
        }, 50);  // Adjust the speed of reverse playback
    }

    // SCROLL IMAGE IN CONTAINER
    const scrollableElements = document.querySelectorAll(".scrollable") ;

    scrollableElements.forEach((scrollable) => {
        const imageElement = scrollable.querySelector("img") as HTMLElement;

            
        let scrollPosition = 0;
        let targetScrollPosition = 0;
        let isScrolling = false;

        scrollable.addEventListener("wheel", (event : any) => {
            event.preventDefault();

            // Adjust the target scroll position
            const scrollAmount = event.deltaY > 0 ? 100 : -100;
                targetScrollPosition = Math.min(
                Math.max(targetScrollPosition + scrollAmount, 0),
                imageElement.clientHeight - scrollable.clientHeight
                );

                if (!isScrolling) {
                isScrolling = true;
                smoothScroll();
                }
        });

        function smoothScroll() {
            const SCROLL_SPEED = 20;

            if (Math.abs(targetScrollPosition - scrollPosition) > 0.5) {
            scrollPosition += (targetScrollPosition - scrollPosition) / SCROLL_SPEED;
            imageElement.style.transform = `translateY(${-scrollPosition}px)`;

            // Continue the animation until the target position is reached
            requestAnimationFrame(smoothScroll);
            } else {
            isScrolling = false;
            }
        }
            
    });


</script>